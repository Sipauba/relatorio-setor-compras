SELECT
    p.codfornec,
    f.fornecedor,
    p.numped,
    p.dtemissao,
    p.vltotal,
    p.codfilial,
    p.codcomprador,
    LISTAGG(N.NUMNOTA, ', ') WITHIN GROUP (ORDER BY N.NUMNOTA) AS NOTAS_FISCAIS,
    CASE
        WHEN p.vltotal = p.vlentregue THEN 'TOTAL'
        WHEN p.vlentregue = 0 THEN 'PENDENTE'
        ELSE 'PARCIAL'
    END AS status_entrega,
    CASE
        WHEN p.tipobonific = 'B' THEN 'BONIFICADO'
        WHEN p.tipobonific = 'N' THEN 'VENDA'
    END AS tipo_pedido
FROM
    pcpedido p
    LEFT JOIN pcfornec f ON p.codfornec = f.codfornec
    LEFT JOIN PCPEDNF PN ON p.numped = PN.numpedido
    LEFT JOIN PCNFENT N ON PN.numtransent = N.numtransent
WHERE
    p.codfilial IN (6)
    AND p.dtemissao BETWEEN TO_DATE('01-OCT-2023', 'DD-MON-YYYY') AND TO_DATE('30-OCT-2023', 'DD-MON-YYYY')
    AND p.codcomprador = 30289
   -- AND N.ESPECIE = 'NF'

GROUP BY
    p.codfornec, f.fornecedor, p.numped, p.dtemissao, p.vltotal, p.codfilial, p.codcomprador,
    CASE
        WHEN p.vltotal = p.vlentregue THEN 'TOTAL'
        WHEN p.vlentregue = 0 THEN 'PENDENTE'
        ELSE 'PARCIAL'
    END,
    CASE
        WHEN p.tipobonific = 'B' THEN 'BONIFICADO'
        WHEN p.tipobonific = 'N' THEN 'VENDA'
    END
ORDER BY
    p.dtemissao;